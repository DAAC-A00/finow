# Flutter 기반 실시간 금융 서비스 Ground Rule 합의서 (v1.1)

**문서 버전: 1.1**
**변경 사항: 웹(Web)을 포함한 크로스플랫폼 지원 강화를 위한 원칙 구체화**

## 1. 개발 목적

*   고빈도 데이터(초당 10회 수준)를 수신하여 **모든 플랫폼(모바일/데스크탑/웹)에서 실시간 뷰 갱신이 가능한 금융 UI**를 구현한다.
*   성능 저하 없이 데이터 수신, 렌더링, 복원력을 확보하는 **크로스 플랫폼 기반 아키텍처 설계 및 구현**을 목표로 한다.

---

## 2. 기술 스택 선정 원칙

| 범주 | 원칙 | 비고 |
| :--- | :--- | :--- |
| **프레임워크** | **Flutter**를 기반으로 개발하며, 동일 코드로 iOS, Android, macOS, Windows, Web까지 지원한다. | |
| **실시간 처리** | API Polling 또는 WebSocket 방식으로 구성 가능하되, 기본 구조는 `WebSocket → Stream → UI` 구조를 우선한다. | |
| **상태 관리** | `Riverpod`을 사용하고, 고빈도 데이터 갱신에 대응하기 위해 `select`, `AsyncNotifier`, `autoDispose` 등의 기능을 활용한다. | |
| **API 통신** | `Dio` 라이브러리를 사용하며, `timeout`, `cancel`, `retry` 로직을 사전에 정의한다. | |
| **캐싱** | **`Hive`**를 사용해 로컬 데이터 fallback 구조를 구축한다. | **웹 호환성 및 안정성을 위해 `Isar`는 사용하지 않음** |
| **라우팅** | **`go_router`**를 사용하여 URL 기반의 화면 이동 및 중첩 라우팅을 관리한다. | **웹 브라우저의 History API와 호환성 강화** |
| **UI 갱신 방식** | `StreamBuilder`, `AnimatedBuilder`, `ValueListenableBuilder` 등의 방식으로 리렌더링 범위를 최소화한다. | |

---

## 3. ⚙️ 성능 최적화 원칙

| 항목 | 내용 |
| :--- | :--- |
| **View 갱신 범위 제한** | 데이터 변경이 있는 특정 영역만 리렌더링하도록 구조를 설계한다. |
| **RepaintBoundary 사용** | 복잡한 UI 요소는 `RepaintBoundary`로 분리하여 불필요한 redraw를 방지한다. |
| **FPS 유지 기준** | 60FPS 이상을 기본 기준으로 하며, 30FPS 이하로 떨어지는 상황은 반드시 로깅/분석한다. |
| **API 요청 타이밍** | polling일 경우 100ms 간격으로 `Timer`를 활용하되, 필요한 경우 diff 기반 갱신만 적용한다. |
| **반응형 UI 구현** | **`LayoutBuilder`와 `MediaQuery`를 활용하여 모바일, 태블릿, 데스크탑 등 다양한 화면 크기에 대응하는 반응형 UI를 구현한다.** |
| **웹 초기 로딩 최적화** | **`deferred loading`(지연 로딩)을 활용하여 앱의 초기 로딩 속도를 최적화하고, 에셋(이미지, 폰트)의 크기를 최소화한다.** |

---

## 4. 안정성과 오류 복원력

| 항목 | 규칙 |
| :--- | :--- |
| **API 실패 시** | 로컬 캐시 또는 마지막 수신 데이터로 fallback UI를 구성한다. |
| **네트워크 불안정 시** | 자동 재연결 및 `Dio RetryInterceptor`를 통한 재시도 로직을 적용한다. |
| **앱 비정상 종료 대응** | `FlutterError.onError`, `Zone`, `Isolate` 에러 핸들러를 공통으로 등록하여 관리한다. |
| **보안** | 모든 민감 데이터는 `flutter_secure_storage`를 활용해 저장한다. API는 HTTPS + SSL pinning 권장. |

---

## 5. 테스트 및 검증 기준

| 항목 | 기준 |
| :--- | :--- |
| **기능 테스트** | 최소 `unit test + widget test`를 구성한다. |
| **성능 테스트** | `Flutter DevTools` 기준으로 GPU/CPU 프레임, GC 발생률 등을 측정하여 리포트 작성한다. |
| **회귀 테스트** | 데이터 갱신 속도에 따른 UI 반응 차트를 주기적으로 점검한다. |
| **QA 도구** | `Crashlytics`, `Sentry`를 기반으로 로그 및 이슈를 통합 관리한다. |

---

## 6. 코드 작성 규칙 (간략 버전)

| 항목 | 규칙 |
| :--- | :--- |
| **위젯 분리** | 하나의 위젯은 하나의 책임만 갖는다. |
| **const 사용** | 가능한 모든 위젯은 `const` 선언을 지킨다. |
| **비동기 처리** | 모든 API 호출은 `try-catch`로 감싸고, 실패 시 UX fallback을 제공한다. |
| **디버깅 로그** | `logger` 패키지를 사용하며, `debug`, `info`, `error` 로그를 구분한다. |
| **플랫폼 분기 처리** | **플랫폼별 코드 분기가 필요할 경우, `kIsWeb` 상수나 `Theme.of(context).platform`을 사용한다. 기능이 복잡하면 파일을 분리하여 관리한다. (e.g., `service_mobile.dart`, `service_web.dart`)** |

---

## 7. Ground Rule 준수 항목 요약표

| 항목 | 준수 여부 확인 항목 |
| :--- | :--- |
| **실시간 구조** | Stream 기반 설계 및 상태 모듈화 |
| **성능 최적화** | Repaint 최소화, FPS 유지, **반응형 UI, 웹 로딩 속도** |
| **안정성 확보** | fallback UI, 에러 핸들링 완비 |
| **상태 관리** | Riverpod 활용, 불필요한 rebuild 차단 |
| **테스트 체계** | 성능, 로직, 회귀 테스트 포함 |
| **공통 모듈화** | API, 모델, UI 공통 요소 디렉토리 분리 설계 |
| **크로스플랫폼** | **`Hive` 단독 사용, `go_router` 적용, 플랫폼별 코드 분기 규칙 준수** |
